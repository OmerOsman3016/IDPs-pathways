<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Remove duplicate Chart.js -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval'">
  <meta name="description" content="Sudan | Displacement Tracking Matrix-Returnees Flow" />
  
  <!-- External CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="./css/styles.css">

  <!-- External JS -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.0/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
  <script src="./src/CanvasFlowmapLayer.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
 
</head>

<body>
  <div class="main-container">
    <!-- Loading Spinner -->
    <div id="loading-spinner">
      <div class="spinner">
        <div class="spinner-dot"></div>
        <div class="spinner-dot"></div>
        <div class="spinner-dot"></div>
        <div class="spinner-dot"></div>
        <div class="spinner-dot"></div>
        <div class="spinner-dot"></div>
        <div class="spinner-dot"></div>
        <div class="spinner-dot"></div>
      </div>
      <div class="loading-text">Loading Displacement Data...</div>
      <div class="loading-text">Sudan's war has created the world's worst displacement crisis, with millions at risk ...</div>
      <div class="loading-progress">
        <div class="loading-progress-bar" id="progress-bar"></div>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard-section">
      <!-- Title Container with Logo, Title, and Info Card -->
      <div id="title-container">
        <div id="title">
          <h1>SUDAN | DISPLACEMENT TRACKING MATRIX - SUDAN MOBILITY</h1>
          <h2><strong>Two Years of Conflict in Sudan - The World's Largest Displacement Crisis</strong></h2>
        </div>
       
        <!-- Add this image element to the right side of the title -->
        <img src="./data/IOM_DTM_WHITE.png" alt="IOM Logo" class="title-image">
      </div>
      
      <!-- Slideshow Gallery -->
      <div class="slideshow-container">
        <div class="slide fade">
          <img src="./data/image5.jpg" alt="Displacement Image 1">
        </div>
        
        <div class="slide fade">
          <img src="./data/image5.jpg" alt="Displacement Image 2">
        </div>
        
        <div class="slide fade">
          <img src="./data/image5.jpg" alt="Displacement Image 3"> 
        </div>
        
        <!-- Next and previous buttons -->
        <a class="prev" onclick="plusSlides(-1)">❮</a>
        <a class="next" onclick="plusSlides(1)">❯</a>
      </div>
      
      <!-- The dots/circles -->
      <div class="dots">
        <span class="dot" onclick="currentSlide(1)"></span> 
        <span class="dot" onclick="currentSlide(2)"></span> 
        <span class="dot" onclick="currentSlide(3)"></span> 
      </div>

      <!-- Dashboard Cards Container -->
      <div class="dashboard-cards">
        <!-- Card 1: Internally Displaced Persons -->
        <div class="dashboard-card" style="--card-color: #2A81CB;">
          <div class="card-icon">
            <img src="./data/Internally displaced.png" alt="IDP Icon" class="card-icon-img">
          </div>
          <h3>Internally Displaced</h3>
          <div class="value">11,301,340</div>
          <div class="change negative">
            <i class="fas fa-arrow-down"></i> 1.7% since last update
          </div>
          <div class="card-footer">Nationwide</div>
        </div>

        <!-- Card 2: Returnees -->
        <div class="dashboard-card" style="--card-color: #5CB85C;">
          <div class="card-icon">
            <img src="./data/Returnees.png" alt="IDP Icon" class="card-icon-img">
          </div>
          <h3>Returnees</h3>
          <div class="value">396,738</div>
          <div class="change positive">
            <i class="fas fa-arrow-up"></i> 0.0% since last update
          </div>
          <div class="card-footer">Nationwide</div>
        </div>

        <!-- Card 3: Crossing Border -->
        <div class="dashboard-card" style="--card-color: #F0AD4E;">
          <div class="card-icon">
            <img src="./data/Crossing Border.png" alt="IDP Icon" class="card-icon-img">
          </div>
          <h3>Crossing Border</h3>
          <div class="value">3,934,086</div>
          <div class="change positive">
            <i class="fas fa-arrow-up"></i> 0.8% since last update
          </div>
          <div class="card-footer">Neighboring countries</div>
        </div>

        <!-- Card 4: Migrants Affected -->
        <div class="dashboard-card" style="--card-color: #D9534F;">
          <div class="card-icon">
            <img src="./data/Crossing Border.png" alt="IDP Icon" class="card-icon-img">  
          </div>
          <h3>Migrants Affected</h3>
          <div class="value">400,000</div>
          <div class="change negative">
            <i class="fas fa-arrow-down"></i> 2.1% since last update
          </div>
          <div class="card-footer">Migrants </div>
        </div>

        <!-- Card 5: Locations Covered -->
        <div class="dashboard-card" style="--card-color: #5BC0DE;">
          <div class="card-icon">
            <img src="./data/Location.png" alt="IDP Icon" class="card-icon-img">  
          </div>
          <h3>Locations Covered</h3>
          <div class="value">10,285</div>
          <div class="change positive">
            <i class="fas fa-arrow-up"></i> 1.2% since last update
          </div>
          <div class="card-footer">Across Sudan</div>
        </div>
      </div>
    </div>
       
 
 
    <!-- IDPs Section -->
    <div class="frame-container">
      <!-- Text Container for Total Number of IDPs by State -->
      <div class="text-container">
        <h2>CONTEXT</h2>
        <p>
        As the conflict in Sudan enters its third year, nearly one third of the population remains displaced, with over 15 million individuals displaced internally or across borders.  The number of internally displaced persons (IDPs) in Sudan has tripled during the conflict, from 3.8 million prior to April 2023 to over 11.3 million in April 2025— the highest number of IDPs ever reported in a country.    Nearly 4 million individuals were displaced to neighbouring countries since April 2023. </p> 
  <p>DTM field teams reported x incidents that triggered sudden displacement since the onset of the conflict between the Sudanese Armed Forces (SAF) and the Rapid Support Forces (RSF) in April 2023, x per cent of which occurred during the second year of conflict . The total number of IDPs increased by 13 per cent during the second year of conflict, while the number of individuals displaced across borders nearly doubled. </p>  
 <p>During the second year of conflict, on-going conflict across North Darfur triggered waves of displacement, while an escalations in clashes across Sennar and Aj Jazirah states. The second year of conflict was also characterized by increased displacement due to natural hazards: DTM field teams reported 131 incidents of floods or heavy rains across 16 different states that displaced nearly 200,000 individuals between June and August 2024. </p>

   
        <h3>KEY FACTS AND FIGURES:</h3>
        <ul>
          <li><strong>15 Million</strong> 30% of a population is displaced both internally and externally</li>
          <li><strong>11.3 Million</strong> people have been displaced internally across all of Sudan, highlighting a severe humanitarian crisis driven by conflict, instability, and other factors.</li>
          <li><strong>3.9 Million</strong> people have been displaced externally from Sudan</li>
          <li><strong>3.63 Million</strong> IDPs are concentrated in South Darfur and North Darfur, underscoring the immense scale of displacement and humanitarian needs in these regions.</li>
          <li><strong>7.4 Million</strong> IDPs have been displaced from Khartoum, South Darfur, and North Darfur,</li>
        </ul>
      </div>

      <!-- Map Container for Total Number of IDPs by State -->
      <div class="map-container">
        <h2 id="map-title-3">Total Number of IDPs by State</h2>
        <button id="drilldown-back" class="drilldown-back">← Back to States</button>
        <div id="map3" class="map"></div>
      </div>
    </div>
    
    <!-- Population Pyramid Section -->
    <div class="population-pyramid-container">
      <h2>IDP Population Pyramid</h2>
      <p class="subtitle">Age and Gender Distribution of Internally Displaced Persons</p>
      
      <div class="chart-container">
        <canvas id="populationPyramidChart"></canvas>
      </div>
      <div class="text-container">
        <h3>Demographic Insights</h3>
        <p><span class="key-point">Youthful Population:</span> The pyramid shows a broad base with <span class="highlight">41% of IDPs under 18 years old</span>, indicating a very young population structure typical of displacement crises.</p>
        
        <p><span class="key-point">Gender Imbalance:</span> There are <span class="highlight">more female IDPs (54%) than male (46%)</span> across most age groups, with the largest disparities in the 18-59 working age bracket.</p>
        
        <p><span class="key-point">Child Displacement:</span> Children aged 0-5 years represent <span class="highlight">16.9% of all IDPs</span>, with 866,389 males and 1,045,329 females in this age group.</p>
        
        <p><span class="key-point">Working Age Adults:</span> The 18-59 age group comprises <span class="highlight">39.7% of IDPs</span>, with 2,054,763 males and 2,436,550 females, reflecting potential impacts on labor markets and household structures.</p>
        
        <p><span class="key-point">Elderly Population:</span> Those aged 60+ represent only <span class="highlight">7.6% of IDPs</span>, with 425,893 males and 434,360 females, suggesting lower survival rates or mobility challenges for older populations in displacement.</p>
      </div>
    </div>
    
    <!-- Displacement Section -->
    <div class="frame-container">
      <div class="text-container">
        <h2>Displacement Proportions by State</h2>
        <p>
          This map visualizes the proportion of each state's population that has been displaced by the ongoing conflict. The pie chart markers show at a glance which states have been most severely affected, with the orange segments representing displaced populations and blue segments showing remaining residents.
        </p>
        <p>
          <strong>Key insights from the map visualization:</strong>
          <ul>
            <li><strong>North Darfur stands out</strong> with the highest displacement proportion (66%) - nearly two-thirds of its population has been forced to flee</li>
            <li><strong>South Darfur shows</strong> the largest absolute numbers (over 2 million displaced) despite being a smaller proportion (53%) of its larger population</li>
            <li><strong>Khartoum's displacement</strong> (3.5 million people) represents 38% of the state's population, visible through the relative sizes of the pie segments</li>
            <li><strong>Northern states</strong> like Northern and Red Sea show much smaller displacement proportions (1-2%), visible through their predominantly blue pie charts</li>
          </ul>
        </p>
        <p>
          <strong>How to interpret the map symbols:</strong>
          <ul>
            <li>Each pie chart is scaled to the state's total population size</li>
            <li>Orange segments show displaced populations</li>
            <li>Blue segments show non-displaced populations</li>
            <li>The percentage label in each pie shows the exact displacement proportion</li>
            <li>Larger pies indicate states with bigger total populations</li>
          </ul>
        </p>
        <p>
          The spatial distribution reveals clear patterns - states in Darfur and Khartoum show the most severe displacement, while northern and eastern states have been less affected. This visualization helps humanitarian actors quickly identify where needs are greatest and how displacement is impacting different regions proportionally.
        </p>
        <p>
          <strong>Map interaction tips:</strong>
          <ul>
            <li>Click on any pie chart to see detailed state statistics</li>
            <li>Compare states by both segment size (proportion) and overall pie size (total population)</li>
            <li>Note the concentration of large orange segments in western Sudan</li>
          </ul>
        </p>
      </div>
      <div class="map-container">
        <div id="map5" class="pie-map"></div>
      </div>
    </div>
    
    <!-- Pathways Section -->
    <div class="frame-container">
      <div class="text-container">
        <h2>IDPs Pathways Across Sudan</h2>
        <p>
          This map visualizes the complex movement patterns of Internally Displaced Persons (IDPs) across Sudan. The animated flow lines represent the pathways taken by displaced populations, with their thickness indicating the relative volume of movement between locations. The map reveals several critical displacement corridors that have emerged during the crisis.
        </p>
        <p>
          <strong>Key displacement patterns shown:</strong>
          <ul>
            <li><strong>Mass exodus from Khartoum:</strong> Thick flow lines show the movement of over 3.5 million people from the capital to neighboring states, particularly to Aj Jazirah, Sennar, and White Nile states.</li>
            <li><strong>Darfur cross-border movements:</strong> Significant flows from Darfur states into neighboring Chad and South Sudan, with particularly heavy movement from West Darfur to Chad.</li>
            <li><strong>Secondary displacement:</strong> Many IDPs who initially fled to relatively safer areas like Aj Jazirah have been forced to move again as conflict spread.</li>
            
          </ul>
        </p>
        <p>
          <strong>How to use this map:</strong>
          <ul>
            <li>Click on any flow line to see details about that displacement pathway</li>
            <li>Note that line thickness represents relative volume - thicker lines indicate larger numbers of displaced persons</li>
            <li>The animation direction shows the direction of displacement</li>
          </ul>
        </p>
        <p>
          These displacement pathways have significant implications for humanitarian response, as they show where needs are concentrated and help predict where populations may move next based on conflict patterns and existing migration routes.
        </p>
      </div>
      <div class="map-container">
        <div id="map2" class="map"></div>
      </div>
    </div>
    
    <!-- Country Circle Propagation Map -->
    <div class="frame-container">
      <div class="text-container">
        <h2>Displacement to Neighboring Countries</h2>
        <p>
          The map below illustrates the significant displacement of Sudanese populations to neighboring countries since the conflict began. The size of each circle represents the relative number of displaced persons in each country, with the largest flows going to Egypt, Chad, and South Sudan. This external displacement has created regional humanitarian challenges, with over 3.9 million Sudanese refugees now living in neighboring countries.
        </p>
        <p>
          <strong>Key observations:</strong>
          <ul>
            <li><strong>Egypt</strong> has received the largest number of displaced persons (1.5 million), representing 38% of all cross-border displacement</li>
            <li><strong>Chad</strong> hosts 767,365 Sudanese refugees, primarily from Darfur region</li>
            <li><strong>South Sudan</strong> has received 341,909 returnees and refugees despite its own humanitarian challenges</li>
            <li>Smaller but significant flows have gone to Ethiopia (88,001), Libya (105,721), and Central African Republic (35,376)</li>
          </ul>
        </p>
        <p>
          These displacement patterns reflect both historical migration routes and the geographical proximity to conflict zones, with Darfur refugees primarily going to Chad, while those from eastern Sudan flee to Ethiopia and Egypt.
        </p>
      </div>
      <div class="map-container">
        <div id="country-circle-map" class="country-circle-map"></div>
      </div>
    </div>  
    
    <!-- IDP Accommodation Data Analysis Section -->
    <div class="frame-container">
      <div class="text-container">
        <h2>Where IDPs Live - Accommodation Analysis</h2>
        <p class="subtitle">Distribution of Internally Displaced Persons by Housing Type</p>
        
        <div class="chart-container">
          <canvas id="accommodationChart"></canvas>
        </div>
        
        <div class="text-container">
          <h3>Data Insights</h3>
          <p><span class="key-point">Dominant Accommodation Type:</span> The data reveals that <span class="highlight">Host Family/Community accommodation</span> houses the largest number of IDPs at <span class="highlight">1,077,264</span> individuals, accounting for approximately 45% of the total displaced population represented in this dataset.</p>
          
          <p><span class="key-point">Formal vs Informal Housing:</span> While <span class="highlight">formal camps</span> accommodate 415,783 IDPs, informal solutions like <span class="highlight">improvised shelters</span> (56,239) and <span class="highlight">informal settlements</span> (385,332) collectively house a significant portion of the population, indicating potential gaps in formal housing solutions.</p>
          
          <p><span class="key-point">Rental Market Pressure:</span> The <span class="highlight">137,092 IDPs in rented accommodations</span> represent a population that may be competing with local residents for housing, potentially driving up rental prices in host communities.</p>
          
          <p><span class="key-point">Public Infrastructure Use:</span> Schools and other public buildings serve as temporary housing for <span class="highlight">206,804 IDPs</span>, which may impact the normal functioning of these institutions and access to services for both displaced and host communities.</p>
          
          <p><span class="key-point">Vulnerability Indicators:</span> The populations in <span class="highlight">improvised shelters</span> (56,239) and <span class="highlight">informal settlements</span> (385,332) are likely the most vulnerable, facing greater protection risks and less access to basic services.</p>
        </div>
      </div>
    </div>

    <!-- Heatmap Section -->
    <div class="frame-container">
      <div class="text-container">
        <h2>Mobility Over Time (2023 - 2025)</h2>
        <p>
          This interactive heatmap visualization shows the progression of displacement over time. The heat intensity represents the number of displaced persons, with darker colors indicating higher numbers. Use the time slider or play button to see how the situation evolved month by month.
        </p>
        <p>
          <strong>Key patterns to observe:</strong>
          <ul>
            <li>The rapid increase in IDPs (blue line) in the first months of the conflict</li>
            <li>The sudden spike in May 2024 when displacement surpassed 10 million</li>
            <li>The appearance of returnees (orange line) only in the most recent data</li>
          </ul>
        </p>
      </div>
      <div class="map-container">
        <div id="heatmapChart" style="height: 400px;"></div>
        <div id="heatmap-controls">
          <button id="heatmap-play-button" class="heatmap-control-button">▶ Play</button>
          <input type="range" id="heatmap-slider" min="0" max="19" value="0" step="1" style="width: 70%; margin: 0 15px;">
          <span id="heatmap-time-display" style="font-weight: bold; color: #418FDE;">Aug-2023</span>
          <button id="heatmap-export-button" class="heatmap-control-button">Export as Image</button>
        </div>
      </div>
    </div>

    <!-- Returnees Section -->
    <div class="frame-container">
      <!-- Map Container for Total Number of Returnees by State -->
      <div class="map-container">
        <h2 id="map-title-4">Total Number of Returnees by State</h2>
        <div id="map4" class="map"></div>
      </div>

      <!-- Text Container for Mobility in Sudan -->
      <div class="text-container">
        <h2>Returns and Cross-Border Movements</h2>
        <p>After two years of continuous conflict and rising displacement, DTM recorded the first decrease in the estimated number of IDPs in March 2023. The number of IDPs decrease by approximately 2 per cent between January and March 2025, due to an increase in return movements to Sennar, Aj Jazirah, and Khartoum states. As of 04 March 2025, DTM field teams recorded nearly 400,000 returnees from internal displacement as well as increased return movements from neighbouring countries. DTM anticipates that millions of displaced households will return to areas of origin as the conflict enters a third year, depending on unfolding dynamics. .</p>
        
        <h3>Primary Return Destinations</h3>
        <ul>
          <li><strong>Aj Jazirah</strong>: 66% of returnees he highest proportion of returnees, driven by improved access and relative stability </li>
          <li><strong>Sennar</strong>: 29% of returnees</li>
          <li><strong>Khartoum</strong>: 5% of returnees Limited returns to the capital reflect ongoing insecurity, infrastructure damage, and lack of basic services.</li>
        </ul>
        
        <h2>Key Findings on Returns</h2>
        <p> the number of internally displaced persons (IDPs) in Sudan has shown a decline, indicating early signs of return movements. However, these returns remain fragile, Many returning households are engaging in short-term visits rather than permanent resettlement, primarily to evaluate security conditions, access essential services, or retrieve belongings. This behavior indicates ongoing insecurity and a lack of confidence in long-term safety.</p>
       
      </div>
    </div>

    <!-- Maps Container for Returnee Pathways -->
    <div class="frame-container">
      <div class="text-container">
        <h2>Returnee Pathways Across Sudan</h2>
        <p>
          This map shows the movement patterns of returnees across Sudan. The flow lines represent the pathways taken by returning populations, with thickness indicating relative volume of movement between locations.
        </p>
      </div>
      <div class="map-container">
        <div id="map" class="map"></div>
      </div>
    </div>
     <!-- Population Distribution Map Container -->
      <div id="population-distribution-map-wrapper"> 
      </div>
    </div>
    <!-- Disclaimer paragraph -->
    <div class="disclaimer">
      <p>
        <strong>DISCLAIMER:</strong>  <p>DTM Sudan is a suite of methodological tools which aims to track and monitor displacement. DTM collects primary data, with a focus on providing the best estimates for the humanitarian community. </p>
    <p> Due to on-going insecurity, DTM collects data through a combination of both in-person and remote interviews with key informants across its network. Figures should be understood as preliminary estimates and are subject to change pending future verification exercises. Figures throughout the report may not equal 100 per cent due to rounding. </p>

      </p>
    </div>

    <!-- Add image above the footer -->
    <img src="./data/doner.png" alt="Donor Logo" class="donor-logo">

    <!-- Footer -->
    <footer>
      <p>&copy; 2025 International Organization for Migration | IOM, UN Migration. Sudan | Displacement Tracking Matrix</p>
      <div class="footer-links">
        <a href="https://dtm.iom.int/sudan" target="_blank">Visit IOM Sudan Website</a>
        <a href="https://displacement.iom.int/" target="_blank">DTM Global Website</a>
      </div>
      <div class="footer-info">
        <p>For more information, please contact <a href="mailto:dtmsudan@iom.int">dtmsudan@iom.int</a>.</p>
      </div>
    </footer>

  <script>
     
    // Initialize the second map
    const map2 = L.map('map2').setView([16, 30], L.Browser.mobile ? 3 : 5.5);

    // Define multiple base layers for the second map
    const cartoDBLight2 = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const openStreetMap2 = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const esriWorldImagery2 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
    });

    const stamenToner2 = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>'
    });

    // Add default base layer to the second map
    mapboxCustom2.addTo(map2);

    // Add layer control to the second map
    const baseLayers2 = {
      "Mapbox Custom": mapboxCustom2,
      "CartoDB Light": cartoDBLight2,
      "OpenStreetMap": openStreetMap2,
      "Esri World Imagery": esriWorldImagery2,
      "Stamen Toner": stamenToner2
    };

    L.control.layers(baseLayers2).addTo(map2);

    // Parse CSV data and create flow map layer for the second map
    Papa.parse('./data/data_idps.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: (results) => {
        const geoJsonFeatureCollection2 = {
          type: 'FeatureCollection',
          features: results.data.map(datum => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [datum.s_lon, datum.s_lat] },
            properties: datum
          }))
        };

        const flowmapLayer2 = L.canvasFlowmapLayer(geoJsonFeatureCollection2, {
          originAndDestinationFieldIds: {
            originUniqueIdField: 's_state_id',
            originGeometry: { x: 's_lon', y: 's_lat' },
            destinationUniqueIdField: 'e_locality_id',
            destinationGeometry: { x: 'e_lon', y: 'e_lat' }
          },
          style: (feature) => {
            const baseRadius = 12;
            const maxRadius = 6;
            const volume = feature.properties.e_Volume || 0;

            const radius = feature.properties.isOrigin
              ? baseRadius
              : Math.min(baseRadius + (volume / 5000), maxRadius);

            return {
              radius: radius,
              weight: 1,
              color: feature.properties.isOrigin ? '#FFFFFF' : '#FFFFFF',
              fillColor: feature.properties.isOrigin ? 'rgb(255, 103, 31)' : '#418FDE',
              fillOpacity: feature.properties.isOrigin ? 0.8 : 0.7
            };
          },
          canvasBezierStyle: {
            type: 'classBreaks',
            field: 'e_Volume',
            classBreakInfos: [
              { classMinValue: 1, classMaxValue: 10000, symbol: { strokeStyle: '#ffb81c', lineWidth: 0.5, lineCap: 'round', shadowColor: '#fee8c8', shadowBlur: 2.0 } },
              { classMinValue: 10001, classMaxValue: 20000, symbol: { strokeStyle: '#ff671f', lineWidth: 1.5, lineCap: 'round', shadowColor: '#fdbb84', shadowBlur: 2.0 } },
              { classMinValue: 20001, classMaxValue: 200000, symbol: { strokeStyle: '#d22630', lineWidth: 3, lineCap: 'round', shadowColor: '#e34a33', shadowBlur: 2.0 } }
            ],
            defaultSymbol: { strokeStyle: '#e7e1ef', lineWidth: 0.5, lineCap: 'round', shadowColor: '#e7e1ef', shadowBlur: 1.5 }
          },
          pathDisplayMode: 'all',
          animationStarted: true,
          animationEasingFamily: 'Linear',
          animationEasingType: 'None',
          animationDuration: 3000,
          onEachFeature: addTooltip
        }).addTo(map2);

        // Add tooltip and popup to features
        function addTooltip(feature, layer) {
          const tooltipContent = feature.properties.isOrigin
            ? `State of Displacement: ${feature.properties.s_State}`
            : `State of Return: ${feature.properties.e_locality}`;

          layer.bindTooltip(tooltipContent);
          layer.on('mouseover', () => layer.openTooltip());
          layer.on('mouseout', () => layer.closeTooltip());

          // Add popup
          const popupContent = feature.properties.isOrigin
            ? `<b>Displacement From:</b> ${feature.properties.s_State}`
            : `<b>Displacement To:</b> ${feature.properties.e_locality}`;

          layer.bindPopup(popupContent);
        }

        // Highlight paths on mouseover
        flowmapLayer2.on('mouseover', (e) => {
          if (e.sharedOriginFeatures.length) {
            flowmapLayer2.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
          }
          if (e.sharedDestinationFeatures.length) {
            flowmapLayer2.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
          }
        });

        // Select initial feature for path display
        flowmapLayer2.selectFeaturesForPathDisplayById('s_state_id', "SD15", true, 'SELECTION_NEW');
      }
    });

    // Add legend to the second map
    const legend2 = L.control({ position: 'bottomright' });
    legend2.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <span style="font-size:14px">Returnee Flow Volume:</span><br/>
        <div style="width:70px;height:3px;background:#ffb81c;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold"> < 10000</span><br/>
        <div style="width:70px;height:4px;background:#ff671f;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold">10,001 - 20,000</span><br/>
        <div style="width:70px;height:7px;background:#e34a33;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold"> > 20,000</span><br/>
      `;
      return div;
    };
    legend2.addTo(map2);

 
  </script>
</body>
</html>
 
